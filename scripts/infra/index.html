<!doctype html>
<html>
    <head>
        <title>Growing Apple Tree</title>
        <style>
            body {
                margin: 0;
            }
            canvas {
                display: block;
            }
            #controls {
                position: absolute;
                top: 10px;
                left: 10px;
                background: rgba(255, 255, 255, 0.8);
                padding: 10px;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <div id="controls">
            <button id="growApple">Grow Apple</button>
            <button id="shakeTree">Shake Tree</button>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.157.0/three.min.js"></script>
        <script>
            // Scene setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000,
            );
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Ground
            const groundGeometry = new THREE.PlaneGeometry(10, 10);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x567d46,
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // Tree trunk
            const trunkGeometry = new THREE.CylinderGeometry(0.2, 0.3, 2, 8);
            const trunkMaterial = new THREE.MeshStandardMaterial({
                color: 0x8b4513,
            });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.y = 1;
            scene.add(trunk);

            // Tree leaves
            const leavesGeometry = new THREE.SphereGeometry(1.5, 8, 8);
            const leavesMaterial = new THREE.MeshStandardMaterial({
                color: 0x228b22,
            });
            const leaves = new THREE.Mesh(leavesGeometry, leavesGeometry);
            leaves.position.y = 2.5;
            scene.add(leaves);

            // Apples array to store all apples
            const apples = [];
            let isShaking = false;

            // Function to create an apple
            function createApple() {
                const appleGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const appleMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff0000,
                });
                const apple = new THREE.Mesh(appleGeometry, appleMaterial);

                // Random position within the tree crown
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 0.8;
                apple.position.x = Math.cos(angle) * radius + trunk.position.x;
                apple.position.z = Math.sin(angle) * radius + trunk.position.z;
                apple.position.y = 2.5 + Math.random() * 0.8;

                scene.add(apple);
                apples.push({
                    mesh: apple,
                    falling: false,
                    velocity: 0,
                });
            }

            // Function to shake the tree
            function shakeTree() {
                if (isShaking) return;
                isShaking = true;

                const originalPosition = trunk.position.clone();
                const shakeAmount = 0.1;
                let time = 0;

                function animate() {
                    if (time >= Math.PI * 4) {
                        isShaking = false;
                        trunk.position.x = originalPosition.x;
                        leaves.position.x = originalPosition.x + 0;
                        return;
                    }

                    trunk.position.x =
                        originalPosition.x + Math.sin(time) * shakeAmount;
                    leaves.position.x = trunk.position.x;

                    // Random chance for apples to start falling
                    apples.forEach((apple) => {
                        if (Math.random() < 0.1) {
                            apple.falling = true;
                        }
                    });

                    time += 0.2;
                    requestAnimationFrame(animate);
                }

                animate();
            }

            // Camera position
            camera.position.z = 8;
            camera.position.y = 3;
            camera.lookAt(0, 2, 0);

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);

                // Update falling apples
                apples.forEach((apple) => {
                    if (apple.falling) {
                        apple.velocity += 0.01;
                        apple.mesh.position.y -= apple.velocity;

                        // Remove apple if it hits the ground
                        if (apple.mesh.position.y <= 0.1) {
                            scene.remove(apple.mesh);
                            const index = apples.indexOf(apple);
                            if (index > -1) {
                                apples.splice(index, 1);
                            }
                        }
                    }
                });

                renderer.render(scene, camera);
            }
            animate();

            // Event listeners
            document
                .getElementById("growApple")
                .addEventListener("click", createApple);
            document
                .getElementById("shakeTree")
                .addEventListener("click", shakeTree);

            // Window resize handler
            window.addEventListener("resize", onWindowResize, false);
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        </script>
    </body>
</html>
